'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}require('babel-polyfill');var express=require('express');var bodyParser=require('body-parser');var uuid=require('uuid');var moment=require('moment');var createDB=require('./lib/create-lowdb.js');var SimpleOAuth2Server=function(){function SimpleOAuth2Server(){_classCallCheck(this,SimpleOAuth2Server);this.protect=this.clean().protect;this.defaultOptions={routes:[],// protect routes
methods:[],// methods for protect routes ['get', 'post', 'delete', 'put']
tokenExpired:24*60*60,// one day
tokenGetPath:'/token',tokenRevocationPath:'/tokenRevocation'}}_createClass(SimpleOAuth2Server,[{key:'init',value:function init(app,options){this._configuring(options);this._fatalErrors(app);this.tokensDB=createDB();app.use(this.appSettings);app.use(this._getTokenRoute);app.use(this._revocationTokensRoute);this.expressApp=app;return this}},{key:'defend',value:function defend(options){this._configuring(options,{routes:['**'],methods:['get','post','delete','put','patch']});this.expressApp.use(this._loadRoutes);return this}},{key:'newLayer',value:function newLayer(){var level=this.protect.length;return this._layer.apply(this,[level].concat(Array.prototype.slice.call(arguments)))}},{key:'or',value:function or(){var level=this.protect.length-1;return this._layer.apply(this,[level].concat(Array.prototype.slice.call(arguments)))}},{key:'_layer',value:function _layer(level){var _this=this;if(!this.protect[level]){this.protect[level]=[]}for(var _len=arguments.length,aFunctions=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){aFunctions[_key-1]=arguments[_key]}aFunctions.forEach(function(aFunction){if(typeof aFunction!=='function'){_this.protect[level].push(_this._shortFunc(aFunction))}else _this.protect[level].push(aFunction)});return this}},{key:'clean',value:function clean(){this.protect=[[this._defaultProtect.bind(this)]];return this}},{key:'authorizationHeader',value:function authorizationHeader(request){return request.get('Authorization')?request.get('Authorization').replace('Bearer ',''):false}},{key:'tokenExtend',value:function tokenExtend(){return{}}},{key:'_configuring',value:function _configuring(){var config=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var defaultOptions=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.defaultOptions;if(config.route){config.routes=config.route}if(config.method){config.methods=config.method}if(typeof config.methods==='string'){config.methods=config.methods.replace(/\s/g,'').split(',')}this.__proto__=Object.assign(this.__proto__,defaultOptions,config)}},{key:'_fatalErrors',value:function _fatalErrors(app){if(!app){throw Error('Where is express application?');exit()}if(!this.checkPassword){throw Error('Function for checking user/password is undefined!');exit()}}},{key:'_protectLayers',value:function _protectLayers(){var _this2=this;var layers=this.protect.filter(cleanEmpty);return function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(req,res,next){var thisLayers,protections;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:thisLayers=layers.map(function(layer){var aFunctions=layer.map(function(aFunction){return _this2._promise(req,aFunction)});return Promise.race(aFunctions)});_context.next=3;return _this2._promiseResult(Promise.all(thisLayers));case 3:protections=_context.sent;if(protections==='success'){next()}else res.status(401).send({// Message for russian hackers!
message:typeof protections==='string'?protections:'\u041E\u0448\u0438\u0431\u043A\u0430 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0438!'});case 5:case'end':return _context.stop();}}},_callee,_this2)}));return function(_x3,_x4,_x5){return _ref.apply(this,arguments)}}();function cleanEmpty(element){return element!==undefined}}},{key:'_defaultProtect',value:function _defaultProtect(req,next,cancel){var access_token=this.authorizationHeader(req);if(access_token){var token=this.tokensDB.get('tokens').find({access_token:access_token}).value();if(validateToken(token)){req.token=token;next()}}cancel('\u041F\u043E\u043F\u044B\u0442\u043A\u0430 \u043D\u0435\u0441\u0430\u043D\u043A\u0446\u0438\u043E\u043D\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u043E\u0433\u043E \u0434\u043E\u0441\u0442\u0443\u043F\u0430!');function validateToken(token){return token&&moment(token.expires_at).add(token.expires_in,'seconds')>=moment()}}},{key:'_checkRefreshToken',value:function _checkRefreshToken(refresh_token){if(isTokenInDB(refresh_token)){this.tokensDB.get('tokens').remove({refresh_token:refresh_token}).write();return true}return false;function isTokenInDB(refresh_token){return refresh_token&&this.tokensDB.get('tokens').hasRec('refresh_token',refresh_token)}}},{key:'_promise',value:function _promise(req,aFunction){return new Promise(function(resolve,reject){aFunction(req,resolve,reject)})}},{key:'_promiseResult',value:function _promiseResult(promise){return promise.then(function(){return'success'}).catch(function(message){return message!=='success'?message:false})}},{key:'_promiseThanCatch',value:function _promiseThanCatch(req,aFunction){return this._promiseResult(this._promise(req,aFunction))}},{key:'_shortFunc',value:function _shortFunc(param){return function(req,next,cancel){param=typeof param==='string'?param.replace(/\s/g,'').split(','):param;if(req.params[param[0]]===req.token[param[0]]||req.token[param[0]]===param[1]){next()}cancel()}}},{key:'appSettings',get:function get(){return express.Router().use(bodyParser.urlencoded({extended:false})).use(function(req,res,next){// Website you wish to allow to connect
res.setHeader('Access-Control-Allow-Origin','*');// Request methods you wish to allow
res.setHeader('Access-Control-Allow-Methods','GET, POST, PUT, DELETE, PATCH');// Request headers you wish to allow
res.setHeader('Access-Control-Allow-Headers','X-Requested-With,content-type,Authorization');// Set to true if you need the website to include cookies in the requests sent
// to the API (e.g. in case you use sessions)
res.setHeader('Access-Control-Allow-Credentials',true);// Pass to next layer of middleware
next()})}},{key:'_getTokenRoute',get:function get(){var authentication=function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(req,res){var refresh_token,authResult,defaultToken,token;return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:refresh_token=req.body.refresh_token;authResult=this._promiseThanCatch(req,this.checkPassword);_context2.t0=this._checkRefreshToken(refresh_token);if(_context2.t0){_context2.next=8;break}_context2.next=6;return authResult;case 6:_context2.t1=_context2.sent;_context2.t0=_context2.t1==='success';case 8:if(!_context2.t0){_context2.next=15;break}defaultToken={access_token:uuid(),refresh_token:uuid(),expires_in:this.tokenExpired,expires_at:moment()};token=Object.assign(this.tokenExtend(req),defaultToken);this.tokensDB.get('tokens').push(token).write();res.send(token);_context2.next=16;break;case 15:res.status(401).send({// Message for russian hackers!
'message':typeof authResult==='string'?authResult:'\u041E\u0448\u0438\u0431\u043A\u0430 \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u0438!'});case 16:case'end':return _context2.stop();}}},_callee2,this)}));return function authentication(_x6,_x7){return _ref2.apply(this,arguments)}}();return express.Router().post(this.tokenGetPath,authentication.bind(this))}},{key:'_revocationTokensRoute',get:function get(){return express.Router().post(this.tokenRevocationPath,deleteTokens.bind(this));function deleteTokens(req,res){var _req$body=req.body,token_type_hint=_req$body.token_type_hint,token=_req$body.token;this.tokensDB.get('tokens').remove(_defineProperty({},token_type_hint,token)).write();res.send()}}},{key:'_loadRoutes',get:function get(){var _this3=this;var router=express.Router();this.methods.forEach(function(method){return router[method](_this3.routes,_this3._protectLayers.call(_this3))});return router}}]);return SimpleOAuth2Server}();module.exports=new SimpleOAuth2Server;
